<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reader - Web Novel</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family: 'Georgia', serif; background:#111; color:#eaeaea; padding:20px; display:flex; justify-content:center; }
        .container { max-width:800px; width:100%; background:#222; padding:28px; border-radius:8px; }
        .header { display:flex; justify-content:space-between; gap:12px; align-items:center; margin-bottom:12px; }
        a.back { color:#ffd166; text-decoration:none; font-size:14px; }
        h1 { color:#ffd166; font-size:20px; }
        .meta { color:#aaa; font-size:13px; margin-bottom:8px; }
        .content { background:#1a1a1a; padding:18px; border-radius:6px; line-height:1.8; min-height:160px; }
        .controls { display:flex; gap:10px; justify-content:space-between; margin-top:12px; }
        button { padding:8px 14px; border-radius:6px; border:none; background:#0066cc; color:#fff; cursor:pointer; }
        button:disabled { opacity:.5; cursor:not-allowed; }
        .lock { margin:10px 0; }
        input[type=password] { padding:8px; border-radius:6px; border:1px solid #444; background:#111; color:#fff; }
        .error { color:#ff6b6b; margin-top:8px; display:none; }
        /* follow button */
        .follow-btn { display:inline-block; background:#ffd166; color:#111; padding:6px 8px; border-radius:6px; font-size:12px; border:none; cursor:pointer; }
        .follow-btn.following { background:#66bb6a; color:#fff; }
        /* cover preview */
        .cover-preview img { width:120px; border-radius:6px; display:block; margin-top:6px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <a class="back" href="index.html">← กลับหน้าหลัก</a>
                <h1 id="title">-</h1>
                <div class="meta">Chapter <span id="chapter">0</span> of <span id="totalChapters">0</span></div>
            </div>
            <div style="display:flex;gap:10px;align-items:center;">
                <span id="author" style="color:#ccc;font-size:13px"></span>
                <button id="followBtn" class="follow-btn" style="margin-left:6px;">ติดตาม</button>
            </div>

            <div style="margin-top:8px;display:flex;gap:12px;align-items:center;">
                <label for="coverInput" style="color:#ccc;font-size:13px;">อัปโหลดหน้าปก:</label>
                <input id="coverInput" type="file" accept="image/*">
                <button id="applyCoverBtn" class="follow-btn" style="margin-left:6px;">ตั้งเป็นหน้าปก</button>
                <div id="coverPreview" class="cover-preview" aria-hidden="true"></div>
            </div>
        </div>

        <div id="noSelection" style="display:none;color:#ccc;margin-bottom:12px;">ไม่มีนิยายที่เลือกไว้ — <a href="index.html" style="color:#ffd166;">กลับไปหน้าแรก</a></div>

        <!-- Per-novel lock section (shown only if novel.accessCode exists and is not unlocked) -->
        <div id="lockSection" style="margin-bottom:12px;display:none;color:#f0f0f0;">
            <div id="lockMessage">นิยายนี้ล็อคอยู่ — ใส่รหัสเพื่อปลดล็อค:</div>
            <div style="display:flex;gap:8px;align-items:center;margin-top:8px;">
                <input id="codeInput" type="password" placeholder="Enter code" style="padding:8px;border-radius:6px;border:1px solid #444;background:#111;color:#fff;">
                <button id="unlockBtn">Unlock</button>
                <button id="lockBtn" style="background:#b30000;display:none;">Lock</button>
            </div>
            <div id="lockError" class="error"></div>
        </div>

        <div id="reader" style="margin-top:10px;">
            <div class="content" id="content">Chapter content will appear here...</div>
            <div class="controls">
                <button id="prevBtn" onclick="previousChapter()">← Previous</button>
                <button id="nextBtn" onclick="nextChapter()">Next →</button>
            </div>
        </div>
    </div>

    <script>
        // Unlock-by-code removed: reader opens directly
        let novel = null;
        let chapters = [];
        let currentChapter = 0;

        function loadChapter(index) {
            currentChapter = index;
            document.getElementById('chapter').textContent = index + 1;
            document.getElementById('totalChapters').textContent = chapters.length;
            document.getElementById('content').textContent = chapters[index].text;
            document.getElementById('prevBtn').disabled = index === 0;
            document.getElementById('nextBtn').disabled = index === chapters.length - 1;
        }
        function nextChapter() { if (currentChapter < chapters.length - 1) loadChapter(currentChapter + 1); }
        function previousChapter() { if (currentChapter > 0) loadChapter(currentChapter - 1); }

        function showReader() {
            document.getElementById('reader').style.display = 'block';
            if (chapters.length) loadChapter(0);
        }

        // follow utilities
        function getFollowedIds() { return JSON.parse(localStorage.getItem('followedNovels') || '[]'); }
        function isFollowedId(id) { return getFollowedIds().includes(id); }
        function setFollow(n) { const ids = getFollowedIds(); if (!ids.includes(n.id)) { ids.unshift(n.id); localStorage.setItem('followedNovels', JSON.stringify(ids)); localStorage.setItem('followedNovel_' + n.id, JSON.stringify(n)); } }
        function removeFollow(n) { const ids = getFollowedIds().filter(i => i !== n.id); localStorage.setItem('followedNovels', JSON.stringify(ids)); localStorage.removeItem('followedNovel_' + n.id); }
        function toggleFollowFromReader(btn) {
            if (!novel) return;
            if (isFollowedId(novel.id)) { removeFollow(novel); btn.classList.remove('following'); btn.textContent='ติดตาม'; }
            else { setFollow(novel); btn.classList.add('following'); btn.textContent='ติดตามแล้ว'; }
        }

        // lock helpers (per-novel)
        function unlockKey() { return 'novelUnlocked_' + (novel ? novel.id : 'none'); }
        function isUnlocked() { return !!(novel && localStorage.getItem(unlockKey()) === 'true'); }
        function setUnlocked(val) { if (!novel) return; localStorage.setItem(unlockKey(), val ? 'true' : 'false'); }

        function attemptUnlock() {
            if (!novel || !novel.accessCode) return showReader();
            const code = document.getElementById('codeInput').value;
            const err = document.getElementById('lockError');
            if (!code) { err.textContent = 'Please enter a code.'; err.style.display = 'block'; return; }
            if (code === String(novel.accessCode)) {
                setUnlocked(true);
                err.style.display = 'none';
                document.getElementById('lockSection').style.display = 'none';
                document.getElementById('lockBtn').style.display = 'inline-block';
                showReader();
            } else {
                err.textContent = 'Incorrect code. Please try again.';
                err.style.display = 'block';
            }
        }

        function lockNovel() {
            if (!novel) return;
            localStorage.removeItem(unlockKey());
            document.getElementById('lockSection').style.display = 'block';
            document.getElementById('lockBtn').style.display = 'none';
            document.getElementById('codeInput').value = '';
            showReader();
        }

        function addToRecentlyRead(n) {
            try {
                let arr = JSON.parse(localStorage.getItem('recentlyRead') || '[]');
                arr = arr.filter(item => item.id !== n.id);
                arr.unshift({ id: n.id, title: n.title, author: n.author, cover: n.cover, lastRead: Date.now(), chapters: n.chapters });
                if (arr.length > 20) arr = arr.slice(0, 20);
                localStorage.setItem('recentlyRead', JSON.stringify(arr));
            } catch(e) { console.error(e); }
        }



        document.addEventListener('DOMContentLoaded', function() {
            const raw = localStorage.getItem('selectedNovel');
            if (!raw) {
                document.getElementById('noSelection').style.display = 'block';
                return;
            }
            novel = JSON.parse(raw);
            document.getElementById('title').textContent = novel.title || '-';
            document.getElementById('author').textContent = novel.author ? 'โดย ' + novel.author : '';
            chapters = (novel.chapters || []).slice();

            // set follow button state and wire it up
            const followBtn = document.getElementById('followBtn');
            if (isFollowedId(novel.id)) { followBtn.classList.add('following'); followBtn.textContent = 'ติดตามแล้ว'; }
            followBtn.addEventListener('click', function() { toggleFollowFromReader(this); });

            // record recent read
            addToRecentlyRead(novel);

            // cover upload UI
            const coverInput = document.getElementById('coverInput');
            const applyCoverBtn = document.getElementById('applyCoverBtn');
            const coverPreview = document.getElementById('coverPreview');
            let pendingCoverData = null;

            // lock UI wiring (per-novel)
            const unlockBtn = document.getElementById('unlockBtn');
            const lockBtn = document.getElementById('lockBtn');
            if (novel.accessCode && !isUnlocked()) {
                document.getElementById('lockSection').style.display = 'block';
                document.getElementById('reader').style.display = 'none';
            } else {
                document.getElementById('lockSection').style.display = 'none';
                document.getElementById('lockBtn').style.display = isUnlocked() ? 'inline-block' : 'none';
            }
            unlockBtn && unlockBtn.addEventListener('click', attemptUnlock);
            document.getElementById('codeInput').addEventListener('keyup', function(e) { if (e.key === 'Enter') attemptUnlock(); });
            lockBtn && lockBtn.addEventListener('click', lockNovel);
            coverInput.addEventListener('change', function(e) {
                const file = e.target.files && e.target.files[0];
                if (!file) { coverPreview.innerHTML = ''; pendingCoverData = null; return; }
                const reader = new FileReader();
                reader.onload = function(ev) {
                    pendingCoverData = ev.target.result;
                    coverPreview.innerHTML = `<img src="${pendingCoverData}" alt="preview">`;
                };
                reader.readAsDataURL(file);
            });

            applyCoverBtn.addEventListener('click', function() {
                if (!pendingCoverData) return alert('โปรดเลือกไฟล์รูปภาพก่อน');
                // save custom cover
                try {
                    localStorage.setItem('customCover_' + novel.id, pendingCoverData);
                    // update selectedNovel
                    novel.cover = pendingCoverData;
                    localStorage.setItem('selectedNovel', JSON.stringify(novel));
                    // update followed copy if exists
                    if (isFollowedId(novel.id)) {
                        localStorage.setItem('followedNovel_' + novel.id, JSON.stringify(novel));
                    }
                    // update recentlyRead if present
                    try {
                        let arr = JSON.parse(localStorage.getItem('recentlyRead') || '[]');
                        arr = arr.map(item => item.id === novel.id ? Object.assign({}, item, { cover: pendingCoverData }) : item);
                        localStorage.setItem('recentlyRead', JSON.stringify(arr));
                    } catch(e) { /* ignore */ }

                    alert('บันทึกหน้าปกเรียบร้อย');
                } catch(err) {
                    console.error(err); alert('ไม่สามารถบันทึกรูปได้ — หน่วยความจำเต็มหรือเบราว์เซอร์ไม่รองรับ');
                }
            });

            showReader();
            // Scroll to top for better view
            document.querySelector('.container').scrollIntoView({ behavior: 'smooth' });
        });
    </script>
</body>
</html>
